# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is a personal dotfiles repository managing system configurations across multiple machines using NixOS with Nix flakes. The repository contains:

- **nix/**: NixOS system and user configurations (primary content)
- **selfhosted/**: Docker Compose files for self-hosted services
- **keyboard/**: Keyboardio keyboard layout configurations

## Repository Structure

### NixOS Configuration (nix/)

The main content is a flake-based NixOS configuration supporting multiple machines:
- `desktop` (hostname: matte-black-cadillac)
- `laptop` (hostname: stylitics-laptop-nixos)
- `framework-laptop` (hostname: framework-laptop-nixos)
- `work-framework-laptop` (hostname: work-laptop-nixos)

#### Core Architecture

**Flake Design Pattern:**
The flake uses a `makeSystem` function (nix/flake.nix:58-105) that creates NixOS configurations with:
- Shared base configuration from configuration.nix
- Machine-specific modules via `extraModules` parameter
- Environment variables passed to home-manager via `envVars` parameter
- Special arguments (`specialArgs`) providing:
  - `pkgs-unstable`: Unstable nixpkgs channel for bleeding-edge packages
  - `inputs`: Direct access to all flake inputs

**Module System:**
Configurations are split into focused modules imported by configuration.nix:
- **emacs.nix**: Systemd user service running Emacs as daemon
- **filesystem.nix**: NFS automounts for NAS (192.168.0.221) at /home/adam/nas/*
- **podman.nix**: Container runtime with Docker compatibility
- **style.nix**: Stylix theme configuration (base16 color schemes, supports dark/light specialisation)
- **browsers.nix**: Browser configuration and defaults
- **audio.nix**: Audio system configuration
- **clojure.nix**: Clojure development environment
- **zen-browser.nix**: Zen browser specific configuration

**Machine Configurations:**
Each machine has two files:
- `{machine}-hardware-configuration.nix`: Hardware-specific settings (generated by NixOS)
- `{machine}.nix`: Machine-specific settings (typically just hostname)

Newer machine configs are in `nix/machines/` subdirectory.

**Custom Packages:**
Located in `nix/packages/`, loaded via `callPackage` in configuration.nix:8. Each package follows standard Nix derivation structure with `default.nix`.

#### Key Configuration Files

- **flake.nix**: Main entry point, defines all inputs and system configurations
- **configuration.nix**: Base system configuration with system packages and services
- **home.nix**: User-level configuration managed by home-manager (packages, dotfiles, shell config)
- **sources/**: Configuration files for various programs (doom emacs, kitty, niri, clojure, etc.)

### Self-Hosted Services (selfhosted/)

Docker Compose configurations for self-hosted applications:
- audiobookshelf, datalevin, emby, grampsweb, miniflux, postgres, qbittorrent

Each service has its own directory with a `compose.yml` file.

### Development Environment

The nix configuration includes a devenv setup:
- Example in `nix/envs/beets/` showing devenv.nix, devenv.yaml, devenv.lock pattern
- Uses direnv for automatic environment activation (.envrc)

## Common Commands

### System Rebuild

The preferred method is using the custom `x-os-rebuild` script:

```sh
# Rebuild system for current hostname (auto-detects which flake configuration to use)
x-os-rebuild
```

The script (nix/sources/scripts/x-os-rebuild) is a Babashka script that:
- Maps hostname to flake configuration
- Ensures doom-emacs repo exists at ~/.config/emacs
- Cleans up unwanted home directories
- Runs `sudo nixos-rebuild switch --flake <path>#<machine>`

Manual rebuild commands:

```sh
# Rebuild for specific machine
sudo nixos-rebuild switch --flake ./nix#desktop
sudo nixos-rebuild switch --flake ./nix#laptop
sudo nixos-rebuild switch --flake ./nix#framework-laptop
sudo nixos-rebuild switch --flake ./nix#work-framework-laptop

# Build without activating
sudo nixos-rebuild build --flake ./nix#<machine>

# Test configuration (doesn't set as boot default)
sudo nixos-rebuild test --flake ./nix#<machine>
```

### Flake Management

```sh
cd nix/

# Update all flake inputs
nix flake update

# Check flake for errors
nix flake check

# Show flake outputs
nix flake show
```

### First-Time Setup for New Machine

Per nix/README.md:

```sh
cd nix/
cp /etc/nixos/hardware-configuration.nix machines/<device-name>-hardware-configuration.nix
cp example-machine.nix machines/<device-name>.nix

# Edit flake.nix to add new machine to nixosConfigurations
# Edit x-os-rebuild script to add hostname -> device-name mapping

sudo nixos-rebuild switch --flake .#<device-name>

# Ensure ~/.config/emacs is a copy of doom-emacs repo
~/.config/emacs/bin/doom install
```

## Important Configuration Patterns

### Adding Packages

**System packages** (configuration.nix:140):
```nix
environment.systemPackages = with pkgs; [
  git
  htop
] ++ [
  pkgs-unstable.some-newer-package  # Use unstable for latest versions
];
```

**User packages** (home.nix:13):
```nix
home.packages = with pkgs; [ package-name ];
```

### Machine-Specific Settings

Pass environment variables via `envVars` in flake.nix (e.g., EMACS_FONT_SIZE varies by machine).

### Secrets Management

Uses agenix with SSH key at /home/adam/.ssh/id_ed25519 (configuration.nix:13). Secrets defined in nix/secrets/secrets.nix (encrypted .age files).

### Dotfile Management

Home-manager manages dotfiles via `home.file` in home.nix:41. Files are symlinked from nix/sources/ to appropriate locations in ~/.config/, ~/.lein/, etc.

## System Details

**Desktop Environment:**
- Window Manager: Niri (Wayland compositor)
- Desktop: GNOME
- Terminal: Kitty (themed via Stylix)
- Shell: zsh with starship, direnv, fzf, zoxide

**Editor:**
- Emacs runs as systemd user service in daemon mode
- Access via: `emacsclient --create-frame`
- Configuration: Doom Emacs (sources/doom/*.el)

**Theming:**
- Stylix provides unified theming across all applications
- Base scheme: selenized-dark (with light mode specialisation available)
- Color scheme automatically applied to kitty, emacs, and other apps

**Version Control:**
- Git configured to rebase on pull by default (home.nix:92)

**NAS Integration:**
- NFS automounts at /home/adam/nas/*
- Mounts are automatic on access with 10-minute idle timeout
- NAS IP: 192.168.0.221

## Working with This Repository

**Making changes:**
1. Edit relevant .nix files
2. Run `x-os-rebuild` or manual `nixos-rebuild` command
3. Changes take effect immediately for most settings
4. Some changes (like systemd services) may require logout/reboot

**Testing changes:**
Use `sudo nixos-rebuild test` to try changes without making them the boot default.

**Flake inputs:**
The configuration tracks both stable (25.05) and unstable nixpkgs channels. Unstable is used for packages that need newer versions (Spotify, Zed editor, Babashka, etc.).
