#!/usr/bin/env bb

(require '[babashka.process :refer [sh shell]])
(require '[babashka.fs :as fs])
(require '[clojure.string :as string])
(require '[clojure.tools.logging :as log])

;; Filesystem helpers ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(defn ensure-git-repo-exists!
  [repo-url output-path & {:keys [shallow?]}]
  (when-not (fs/exists? output-path)
    (let [git-clone (if shallow?
                      "git clone --depth 1"
                      "git clone")]
      (sh git-clone repo-url output-path))))

(defn delete-directories-if-exist!
  [& paths]
  (doseq [path paths]
    (when (fs/exists? path)
      (if (empty? (fs/list-dir path))
        (fs/delete (fs/file path))
        (log/warnf "Will not delete non-empty directory '%s'" path)))))

;; Nix helpers ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(defn hostname
  []
  (-> (sh "hostname")
      (:out)
      (string/trim)))

(defn flake-path
  []
  (case (hostname)
    "matte-black-cadillac"   "/home/adam/src/dotfiles/nix#desktop"
    "framework-laptop-nixos" "/home/adam/src/dotfiles/nix#framework-laptop"
    "work-laptop-nixos"      "/home/adam/src/dotfiles/nix#work-framework-laptop"))

;; Config ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(ensure-git-repo-exists!
  "https://github.com/doomemacs/doomemacs"
  "/home/adam/.config/emacs"
  :shallow? true)

(delete-directories-if-exist!
  "/home/adam/Desktop"
  "/home/adam/Documents"
  "/home/adam/Downloads"
  "/home/adam/Music"
  "/home/adam/Pictures"
  "/home/adam/Public"
  "/home/adam/Templates"
  "/home/adam/Videos")

;; Generate blackout hosts file if it doesn't exist
(let [blackout-hosts-file "/home/adam/src/private-nix/sources/hosts/blackout-hosts"]
  (when-not (fs/exists? blackout-hosts-file)
    (println "Generating blackout hosts file (this only happens once)...")
    (shell "x-blackout-hosts")))

(try
  (shell "sudo nixos-rebuild switch --flake" (flake-path))
  (catch Exception ex
    (prn (.getMessage ex))
    (System/exit 1)))

(System/exit 0)
